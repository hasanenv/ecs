name: ci-cd pipeline

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:
    inputs:
      infra_ready:
        description: "Is infrastructure deployed?"
        type: choice
        required: true
        default: "false"
        options:
          - "false"
          - "true"

permissions:
  contents: read
  id-token: write

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest

    steps:
      - name: checkout code
        uses: actions/checkout@v4

      - name: docker build (validation only)
        run: docker build -t ci:test ./app/gatus

      - name: setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.5

      - name: terraform fmt
        working-directory: infra/
        run: terraform fmt -check -recursive

      - name: terraform init (no backend)
        working-directory: infra/
        run: terraform init -backend=false

      - name: terraform validate
        working-directory: infra/
        run: terraform validate

      - name: install tflint
        run: |
          curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

      - name: run tflint
        working-directory: infra/
        run: tflint

      - name: scan image
        uses: anchore/scan-action@v6
        with:
          image: "ci:test"
          severity-cutoff: high

      - name: CI summary
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "- Docker build: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform fmt: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform validate: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- tflint: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Image scan: ✅" >> $GITHUB_STEP_SUMMARY

  cd:
    name: CD
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event.inputs.infra_ready == 'true'
    runs-on: ubuntu-latest
    concurrency:
      group: cd-main
      cancel-in-progress: true

    steps:

      - name: checkout code
        uses: actions/checkout@v4

      - name: setup terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.5

      - name: configure aws credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::727646481331:role/hasanenv-cd-role-ecs
          aws-region: eu-west-2

      - name: auth to ecr
        run: |
          aws ecr get-login-password --region eu-west-2 \
          | docker login --username AWS --password-stdin 727646481331.dkr.ecr.eu-west-2.amazonaws.com

      - name: build image, tag, push
        run: |
          docker build -t hasanenv/gatus:${{ github.sha }} ./app/gatus
          docker tag hasanenv/gatus:${{ github.sha }} 727646481331.dkr.ecr.eu-west-2.amazonaws.com/gatus-repo:${{ github.sha }}
          docker push 727646481331.dkr.ecr.eu-west-2.amazonaws.com/gatus-repo:${{ github.sha }}

      - name: terraform deploy
        working-directory: infra/
        env:
          TF_IN_AUTOMATION: true
          TF_VAR_image_tag: ${{ github.sha }}
          TF_VAR_aws_region: eu-west-2
          TF_VAR_owner: hasan
          TF_VAR_availability_zones: '["eu-west-2a","eu-west-2b"]'
          TF_VAR_vpc_cidr: "10.0.0.0/16"
          TF_VAR_public_subnet_cidrs: '["10.0.1.0/24","10.0.2.0/24"]'
          TF_VAR_private_subnet_cidrs: '["10.0.101.0/24","10.0.102.0/24"]'
        run: |
          terraform init
          terraform apply -auto-approve -input=false

      - name: health check
        run: curl -f --max-time 10 https://tm.hasangatus.click/health

      - name: CD summary
        if: always()
        run: |
          echo "## CD Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Image tag: \`$GITHUB_SHA\`" >> $GITHUB_STEP_SUMMARY
          echo "- ECR push: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Terraform apply: ✅" >> $GITHUB_STEP_SUMMARY
          echo "- Health check: ✅" >> $GITHUB_STEP_SUMMARY