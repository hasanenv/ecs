name: cd pipeline

on:
  push:
    branches:
      - main

  workflow_dispatch:

permissions:
  id-token: write
  contents: read
    
jobs:
  cd:
    runs-on: ubuntu-latest
    concurrency:
      group: cd-main
      cancel-in-progress: true

    steps:
      
        - name: checkout code
          uses: actions/checkout@v4
        
        - name: setup terraform
          uses: hashicorp/setup-terraform@v3
          with:
            terraform_version: 1.5.5

        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: arn:aws:iam::727646481331:role/hasanenv-cd-role-ecs  # temp creds via OIDC
            aws-region: eu-west-2

        - name: auth to AWS 
          run: |
            aws ecr get-login-password --region eu-west-2 \
            | docker login --username AWS --password-stdin 727646481331.dkr.ecr.eu-west-2.amazonaws.com

        - name: build image, tag, push
          run: |
            docker build -t hasanenv/gatus:${{ github.sha }} ./app/gatus/
            docker tag hasanenv/gatus:${{ github.sha }} 727646481331.dkr.ecr.eu-west-2.amazonaws.com/gatus-repo:${{ github.sha }}
            docker push 727646481331.dkr.ecr.eu-west-2.amazonaws.com/gatus-repo:${{ github.sha }}

        - name: terraform deploy
          working-directory: infra/
          env:
            TF_IN_AUTOMATION: true
          run: |
            terraform init
            terraform apply -auto-approve \
              -var="image_tag=${{ github.sha }}" \
              -var='availability_zones=["eu-west-2a","eu-west-2b"]' \
              -var="aws_region=eu-west-2"

        - name: health check
          run: |
            curl -f --max-time 10 https://tm.hasangatus.click/health

        - name: CD summary
          if: always()
          run: |
            echo "## CD Deployment Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Image tag: \`$GITHUB_SHA\`" >> $GITHUB_STEP_SUMMARY
            echo "- ECR push: ✅" >> $GITHUB_STEP_SUMMARY
            echo "- Terraform apply: ✅" >> $GITHUB_STEP_SUMMARY
            echo "- Health check: ✅" >> $GITHUB_STEP_SUMMARY